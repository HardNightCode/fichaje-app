{% extends "base.html" %}
{% block title %}Usuarios - Fichas y gestión{% endblock %}

{% block content %}
<h1>Usuarios</h1>
<p class="text-muted">
  Desde aquí puedes acceder a la ficha de configuración (ubicaciones y horarios),
  cambiar el rol, eliminar usuarios y resetear contraseñas.
</p>

<div class="table-responsive mt-3">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Usuario</th>
        <th>Rol</th>
        <th>Debe cambiar contraseña</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for u in usuarios %}
      <tr>
        <td>{{ u.username }}</td>
        <td>
          <form method="post" action="{{ url_for('admin_usuarios_fichas') }}" class="d-flex gap-2 align-items-center">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <input type="hidden" name="action" value="update_role">
            <select name="role" class="form-select form-select-sm w-auto">
              <option value="empleado" {% if u.role == 'empleado' %}selected{% endif %}>Empleado</option>
              <option value="kiosko" {% if u.role == 'kiosko' %}selected{% endif %}>Kiosko</option>
              <option value="kiosko_admin" {% if u.role == 'kiosko_admin' %}selected{% endif %}>Kiosko admin</option>
              <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>Admin</option>
            </select>
            <button type="submit" class="btn btn-sm btn-outline-primary">Guardar</button>
          </form>
        </td>
        <td>
          {% if u.must_change_password %}
            <span class="badge bg-warning text-dark">Sí</span>
          {% else %}
            <span class="badge bg-secondary">No</span>
          {% endif %}
        </td>
        <td>
          <div class="btn-group btn-group-sm" role="group">
            <a href="{{ url_for('admin_usuario_ficha', user_id=u.id) }}" class="btn btn-outline-secondary">
              Ficha
            </a>
            <a href="{{ url_for('admin_usuario_qr', user_id=u.id) }}" class="btn btn-outline-secondary">
              QR
            </a>

            <!-- Botón para abrir modal de reset contraseña -->
            <button type="button"
                    class="btn btn-outline-info"
                    data-bs-toggle="modal"
                    data-bs-target="#resetPasswordModal_{{ u.id }}">
              Reset contraseña
            </button>

            <!-- Eliminar usuario -->
            <form method="post"
                  action="{{ url_for('admin_usuarios_fichas') }}"
                  onsubmit="return confirm('¿Seguro que quieres eliminar al usuario {{ u.username }}? Esta acción es irreversible.');"
                  class="d-inline">
              <input type="hidden" name="user_id" value="{{ u.id }}">
              <input type="hidden" name="action" value="delete">
              <button type="submit" class="btn btn-outline-danger">
                Eliminar
              </button>
            </form>
          </div>
        </td>
      </tr>

      <!-- Modal de reset de contraseña para este usuario -->
      <div class="modal fade" id="resetPasswordModal_{{ u.id }}" tabindex="-1"
           aria-labelledby="resetPasswordLabel_{{ u.id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="{{ url_for('admin_reset_password', user_id=u.id) }}">
              <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordLabel_{{ u.id }}">
                  Resetear contraseña - {{ u.username }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">

                <div class="mb-3">
                  <label for="new_password_{{ u.id }}" class="form-label">Nueva contraseña</label>
                  <input type="password"
                         class="form-control"
                         id="new_password_{{ u.id }}"
                         name="new_password"
                         required>
                </div>

                <div class="form-check mb-2">
                  <input class="form-check-input"
                         type="checkbox"
                         id="must_change_password_{{ u.id }}"
                         name="must_change_password"
                         {% if u.must_change_password %}checked{% endif %}>
                  <label class="form-check-label" for="must_change_password_{{ u.id }}">
                    Obligar a que el usuario cambie la contraseña al iniciar sesión
                  </label>
                </div>

                <p class="text-muted mb-0">
                  Al guardar, la contraseña se cambiará inmediatamente.
                  Si marcas la casilla, al siguiente inicio de sesión se le pedirá al usuario que la cambie.
                </p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar nueva contraseña</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
