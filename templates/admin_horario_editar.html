{% extends "base.html" %}

{% block title %}Editar horario - Administración{% endblock %}

{% block content %}
<h1 class="mb-4">Editar horario: {{ horario.name }}</h1>

<style>
  .day-disabled input,
  .day-disabled select {
    background-color: #f1f3f5 !important;
    color: #6c757d !important;
  }
  .day-disabled .form-control[disabled],
  .day-disabled .form-select[disabled] {
    opacity: 1;
  }
  .day-toggle-btn {
    width: 2rem;
  }
  .per-day-table th,
  .per-day-table td {
    white-space: nowrap;
    font-size: 0.85rem;
    padding: 0.3rem 0.4rem;
  }
  .per-day-table {
    min-width: 980px;
  }
  .break-options-group {
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 0.6rem 0.75rem;
    background: #f8f9fa;
  }
</style>

<div class="row">
  <div class="col-xl-9 col-lg-10 col-12">
    <div class="card mb-4">
      <div class="card-header">
        Editar horario
      </div>
      <div class="card-body">
        <form action="{{ url_for('editar_horario', schedule_id=horario.id) }}"
              method="post" class="row g-3">

          <div class="col-12">
            <label class="form-label">Nombre del horario</label>
            <input type="text" name="name" class="form-control"
                   value="{{ horario.name }}" required>
          </div>

          {# =================== MODO SIMPLE =================== #}
          <div id="simple-schedule-wrapper" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Inicio jornada</label>
              <input type="time" name="start_time" class="form-control"
                     value="{{ horario.start_time.strftime('%H:%M') if horario.start_time }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Fin jornada</label>
              <input type="time" name="end_time" class="form-control"
                     value="{{ horario.end_time.strftime('%H:%M') if horario.end_time }}">
            </div>

            <div class="col-12">
              <label class="form-label">Descanso (modo simple)</label>
              <select name="break_type" id="break_type_global" class="form-select">
                <option value="none" {% if horario.break_type == 'none' %}selected{% endif %}>Sin descanso</option>
                <option value="fixed" {% if horario.break_type == 'fixed' %}selected{% endif %}>Descanso fijo</option>
                <option value="flexible" {% if horario.break_type == 'flexible' %}selected{% endif %}>Descanso flexible</option>
              </select>
            </div>

            <div class="col-md-6 global-descanso-fijo d-none">
              <label class="form-label">Inicio descanso fijo</label>
              <input type="time" name="break_start" class="form-control"
                     value="{{ horario.break_start.strftime('%H:%M') if horario.break_start }}">
            </div>
            <div class="col-md-6 global-descanso-fijo d-none">
              <label class="form-label">Fin descanso fijo</label>
              <input type="time" name="break_end" class="form-control"
                     value="{{ horario.break_end.strftime('%H:%M') if horario.break_end }}">
            </div>

            <div class="col-md-6 global-descanso-flexible d-none">
              <label class="form-label">Descanso flexible (minutos)</label>
              <input type="number" min="0" name="break_minutes" class="form-control"
                     value="{{ horario.break_minutes if horario.break_minutes is not none }}">
            </div>

            <div class="col-12">
              <div class="break-options-group">
                <div class="form-check">
                  <input class="form-check-input global-break-optional"
                         type="checkbox" name="break_optional" id="break_optional_global"
                         {% if horario.break_optional %}checked{% endif %}
                         {% if horario.break_type == 'none' %}disabled{% endif %}>
                  <label class="form-check-label" for="break_optional_global">Pausa optativa</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input global-break-unpaid"
                         type="checkbox" name="break_unpaid" id="break_unpaid_global"
                         {% if horario.break_type != 'none' and not horario.break_paid %}checked{% endif %}
                         {% if horario.break_type == 'none' %}disabled{% endif %}>
                  <label class="form-check-label" for="break_unpaid_global">Pausa no retribuida</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input global-break-paid"
                         type="checkbox" name="break_paid" id="break_paid_global"
                         {% if horario.break_paid %}checked{% endif %}
                         {% if horario.break_type == 'none' %}disabled{% endif %}>
                  <label class="form-check-label" for="break_paid_global">Pausa retribuida</label>
                </div>
              </div>
            </div>
          </div>

          <hr class="mt-4">

          {# ============ MODO POR DÍAS DE LA SEMANA ============ #}
          <div class="col-12">
            <div class="d-flex align-items-center mb-2">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox"
                       id="use_per_day" name="use_per_day" value="1"
                       {% if horario.use_per_day %}checked{% endif %}>
                <label class="form-check-label" for="use_per_day">
                  Configurar horario distinto por días de la semana
                </label>
              </div>

              <button type="button"
                      class="btn btn-sm btn-outline-secondary ms-3"
                      id="copy-first-day-btn"
                      title="Copiar configuración del primer día al resto"
                      style="display: none;">
                ↓
              </button>
            </div>
          </div>

          <div class="col-12" id="per-day-wrapper" style="display: none;">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0 per-day-table">
                <thead class="table-light">
                  <tr>
                    <th class="text-center" style="width: 3rem;">&nbsp;</th>
                    <th>Día</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Descanso</th>
                    <th>Inicio descanso</th>
                    <th>Fin descanso</th>
                    <th>Min. descanso</th>
                    <th>Optativa</th>
                    <th>No retrib.</th>
                    <th>Retrib.</th>
                  </tr>
                </thead>
                <tbody>
                  {% set dias = [
                    ('mon', 'Lunes', 0),
                    ('tue', 'Martes', 1),
                    ('wed', 'Miércoles', 2),
                    ('thu', 'Jueves', 3),
                    ('fri', 'Viernes', 4),
                    ('sat', 'Sábado', 5),
                    ('sun', 'Domingo', 6)
                  ] %}
                  {% for prefix, nombre, dow in dias %}
                    {% set d = dias_map.get(dow) if dias_map is defined else None %}
                    {% set is_active = 1 if d else 0 %}
                    <tr class="day-row"
                        data-prefix="{{ prefix }}"
                        data-active="{{ is_active }}">
                      <td class="text-center">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary day-toggle-btn day-toggle"
                                data-prefix="{{ prefix }}">
                          {% if is_active %}&minus;{% else %}+{% endif %}
                        </button>
                      </td>
                      <td>{{ nombre }}</td>
                      <td>
                        <input type="time" name="{{ prefix }}_start"
                               class="form-control form-control-sm"
                               value="{{ d.start_time.strftime('%H:%M') if d }}">
                      </td>
                      <td>
                        <input type="time" name="{{ prefix }}_end"
                               class="form-control form-control-sm"
                               value="{{ d.end_time.strftime('%H:%M') if d }}">
                      </td>
                      <td>
                        {% set bt = d.break_type if d else 'none' %}
                        <select name="{{ prefix }}_break_type"
                                class="form-select form-select-sm day-break-type"
                                data-prefix="{{ prefix }}">
                          <option value="none" {% if bt == 'none' %}selected{% endif %}>Sin descanso</option>
                          <option value="fixed" {% if bt == 'fixed' %}selected{% endif %}>Descanso fijo</option>
                          <option value="flexible" {% if bt == 'flexible' %}selected{% endif %}>Descanso flexible</option>
                        </select>
                      </td>
                      <td>
                        <input type="time" name="{{ prefix }}_break_start"
                               class="form-control form-control-sm"
                               value="{{ d.break_start.strftime('%H:%M') if d and d.break_start }}">
                      </td>
                      <td>
                        <input type="time" name="{{ prefix }}_break_end"
                               class="form-control form-control-sm"
                               value="{{ d.break_end.strftime('%H:%M') if d and d.break_end }}">
                      </td>
                      <td>
                        <input type="number" min="0"
                               name="{{ prefix }}_break_minutes"
                               class="form-control form-control-sm"
                               value="{{ d.break_minutes if d and d.break_minutes is not none }}">
                      </td>
                      <td class="text-center">
                        <input type="checkbox"
                               class="form-check-input day-break-optional"
                               name="{{ prefix }}_break_optional"
                               data-prefix="{{ prefix }}"
                               {% if d and d.break_optional %}checked{% endif %}
                               {% if bt == 'none' %}disabled{% endif %}>
                      </td>
                      <td class="text-center">
                        <input type="checkbox"
                               class="form-check-input day-break-unpaid"
                               name="{{ prefix }}_break_unpaid"
                               data-prefix="{{ prefix }}"
                               {% if d and d.break_type != 'none' and not d.break_paid %}checked{% endif %}
                               {% if bt == 'none' %}disabled{% endif %}>
                      </td>
                      <td class="text-center">
                        <input type="checkbox"
                               class="form-check-input day-break-paid"
                               name="{{ prefix }}_break_paid"
                               data-prefix="{{ prefix }}"
                               {% if d and d.break_paid %}checked{% endif %}
                               {% if bt == 'none' %}disabled{% endif %}>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <p class="text-muted small mt-2 mb-0">
              Cualquier día sin hora de inicio/fin se interpretará como
              <strong>no laborable</strong>.
            </p>
          </div>

          <div class="col-12 mt-4">
            <button type="submit" class="btn btn-success">
              Guardar cambios
            </button>
            <a href="{{ url_for('admin_horarios') }}" class="btn btn-secondary ms-2">
              Volver
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const DAY_PREFIXES = ["mon","tue","wed","thu","fri","sat","sun"];

  function updateGlobalBreakFields() {
    const tipo = document.getElementById('break_type_global').value;
    const fijoElems = document.querySelectorAll('.global-descanso-fijo');
    const flexElems = document.querySelectorAll('.global-descanso-flexible');
    const opt = document.querySelector('.global-break-optional');
    const unpaid = document.querySelector('.global-break-unpaid');
    const paid = document.querySelector('.global-break-paid');

    if (tipo === 'fixed') {
      fijoElems.forEach(e => e.classList.remove('d-none'));
      flexElems.forEach(e => e.classList.add('d-none'));
    } else if (tipo === 'flexible') {
      fijoElems.forEach(e => e.classList.add('d-none'));
      flexElems.forEach(e => e.classList.remove('d-none'));
    } else {
      fijoElems.forEach(e => e.classList.add('d-none'));
      flexElems.forEach(e => e.classList.add('d-none'));
    }

    const enabled = tipo !== 'none';
    [opt, unpaid, paid].forEach(el => {
      if (!el) return;
      el.disabled = !enabled;
      if (!enabled) {
        el.checked = false;
      }
    });

    if (enabled && unpaid && paid && !unpaid.checked && !paid.checked) {
      unpaid.checked = true;
    }
  }

  function setDayEnabled(prefix, enabled) {
    const row = document.querySelector(`tr.day-row[data-prefix="${prefix}"]`);
    if (!row) return;

    const toggleBtn = row.querySelector('.day-toggle');
    const inputs = row.querySelectorAll('input, select');

    if (!enabled) {
      row.classList.add('day-disabled');
      row.dataset.active = "0";
      if (toggleBtn) toggleBtn.textContent = "+";

      inputs.forEach(el => {
        if (el === toggleBtn) return;
        if (el.name.endsWith('_start') || el.name.endsWith('_end') ||
            el.name.endsWith('_break_start') || el.name.endsWith('_break_end') ||
            el.name.endsWith('_break_minutes') || el.name.endsWith('_break_optional') ||
            el.name.endsWith('_break_unpaid') || el.name.endsWith('_break_paid')) {
          if (el.type === "checkbox") {
            el.checked = false;
          } else {
            el.value = "";
          }
        }
        if (el.tagName === "SELECT" && el.name.endsWith('_break_type')) {
          el.value = "none";
        }
        if (el !== toggleBtn) {
          el.disabled = true;
        }
      });
    } else {
      row.classList.remove('day-disabled');
      row.dataset.active = "1";
      if (toggleBtn) toggleBtn.textContent = "–";

      inputs.forEach(el => {
        if (el !== toggleBtn) {
          el.disabled = false;
        }
      });
      updateDayBreakFields(prefix);
    }
  }

  function updateDayBreakFields(prefix) {
    const row = document.querySelector(`tr.day-row[data-prefix="${prefix}"]`);
    if (!row) return;

    if (row.classList.contains('day-disabled')) {
      const all = row.querySelectorAll('input, select');
      all.forEach(el => {
        if (!el.classList.contains('day-toggle')) {
          el.disabled = true;
        }
      });
      return;
    }

    const sel = row.querySelector(`select[name="${prefix}_break_type"]`);
    const bs = row.querySelector(`input[name="${prefix}_break_start"]`);
    const be = row.querySelector(`input[name="${prefix}_break_end"]`);
    const bm = row.querySelector(`input[name="${prefix}_break_minutes"]`);
    const opt = row.querySelector(`input[name="${prefix}_break_optional"]`);
    const unpaid = row.querySelector(`input[name="${prefix}_break_unpaid"]`);
    const paid = row.querySelector(`input[name="${prefix}_break_paid"]`);

    if (!sel || !bs || !be || !bm) return;

    // Primero habilitamos todo
    bs.disabled = false;
    be.disabled = false;
    bm.disabled = false;

    if (sel.value === "none") {
      bs.value = "";
      be.value = "";
      bm.value = "";
      bs.disabled = true;
      be.disabled = true;
      bm.disabled = true;
      [opt, unpaid, paid].forEach(el => {
        if (!el) return;
        el.checked = false;
        el.disabled = true;
      });
    } else if (sel.value === "fixed") {
      bm.value = "";
      bm.disabled = true;
      bs.disabled = false;
      be.disabled = false;
      [opt, unpaid, paid].forEach(el => {
        if (!el) return;
        el.disabled = false;
      });
    } else if (sel.value === "flexible") {
      bs.value = "";
      be.value = "";
      bs.disabled = true;
      be.disabled = true;
      bm.disabled = false;
      [opt, unpaid, paid].forEach(el => {
        if (!el) return;
        el.disabled = false;
      });
    }

    if (sel.value !== "none" && unpaid && paid && !unpaid.checked && !paid.checked) {
      unpaid.checked = true;
    }
  }

  function updatePerDayVisibility() {
    const chk = document.getElementById('use_per_day');
    const perDayWrapper = document.getElementById('per-day-wrapper');
    const simpleWrapper = document.getElementById('simple-schedule-wrapper');
    const copyBtn = document.getElementById('copy-first-day-btn');

    if (chk.checked) {
      perDayWrapper.style.display = '';
      simpleWrapper.style.opacity = 0.3;
      Array.from(simpleWrapper.querySelectorAll('input, select')).forEach(el => {
        el.disabled = true;
      });
      if (copyBtn) {
        copyBtn.style.display = '';
        copyBtn.disabled = false;
      }
    } else {
      perDayWrapper.style.display = 'none';
      simpleWrapper.style.opacity = 1;
      Array.from(simpleWrapper.querySelectorAll('input, select')).forEach(el => {
        el.disabled = false;
      });
      if (copyBtn) {
        copyBtn.style.display = 'none';
        copyBtn.disabled = true;
      }
    }
  }

  function copyFirstDayToOthers() {
    const chk = document.getElementById('use_per_day');
    if (!chk || !chk.checked) return;

    const srcPrefix = DAY_PREFIXES[0]; // lunes
    const srcRow = document.querySelector(`tr.day-row[data-prefix="${srcPrefix}"]`);
    if (!srcRow || srcRow.dataset.active === "0") return;

    const fields = ["start", "end", "break_type", "break_start", "break_end", "break_minutes"];

    function getField(prefix, field) {
      return document.querySelector(`[name="${prefix}_${field}"]`);
    }

    fields.forEach(field => {
      const srcEl = getField(srcPrefix, field);
      if (!srcEl) return;
      const value = srcEl.value;

      DAY_PREFIXES.slice(1).forEach(prefix => {
        const row = document.querySelector(`tr.day-row[data-prefix="${prefix}"]`);
        if (!row || row.dataset.active === "0") return;

        const dstEl = getField(prefix, field);
        if (!dstEl) return;
        dstEl.value = value;
      });
    });

    ["break_optional", "break_unpaid", "break_paid"].forEach(field => {
      const srcEl = getField(srcPrefix, field);
      if (!srcEl) return;
      const checked = srcEl.checked;

      DAY_PREFIXES.slice(1).forEach(prefix => {
        const row = document.querySelector(`tr.day-row[data-prefix="${prefix}"]`);
        if (!row || row.dataset.active === "0") return;
        const dstEl = getField(prefix, field);
        if (!dstEl) return;
        dstEl.checked = checked;
      });
    });

    DAY_PREFIXES.forEach(updateDayBreakFields);
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Global (modo simple)
    const selGlobal = document.getElementById('break_type_global');
    if (selGlobal) {
      selGlobal.addEventListener('change', updateGlobalBreakFields);
      updateGlobalBreakFields();
    }

    const unpaidGlobal = document.getElementById('break_unpaid_global');
    const paidGlobal = document.getElementById('break_paid_global');
    if (unpaidGlobal && paidGlobal) {
      unpaidGlobal.addEventListener('change', () => {
        if (unpaidGlobal.checked) paidGlobal.checked = false;
      });
      paidGlobal.addEventListener('change', () => {
        if (paidGlobal.checked) unpaidGlobal.checked = false;
      });
    }

    // Checkbox de modo por días
    const chk = document.getElementById('use_per_day');
    if (chk) {
      chk.addEventListener('change', updatePerDayVisibility);
      updatePerDayVisibility();
    }

    // Inicializar días según datos existentes
    DAY_PREFIXES.forEach(prefix => {
      const row = document.querySelector(`tr.day-row[data-prefix="${prefix}"]`);
      if (!row) return;
      const active = row.dataset.active !== "0";
      setDayEnabled(prefix, active);
      if (active) {
        updateDayBreakFields(prefix);
      }
    });

    // Eventos toggle +/-
    document.querySelectorAll('.day-toggle').forEach(btn => {
      btn.addEventListener('click', function() {
        const prefix = this.dataset.prefix;
        const row = document.querySelector(`tr.day-row[data-prefix="${prefix}"]`);
        const active = row.dataset.active !== "0";
        setDayEnabled(prefix, !active);
      });
    });

    // Cambio tipo descanso por día
    document.querySelectorAll('.day-break-type').forEach(sel => {
      sel.addEventListener('change', function() {
        const prefix = this.dataset.prefix;
        updateDayBreakFields(prefix);
      });
    });

    document.querySelectorAll('.day-break-unpaid').forEach(chk => {
      chk.addEventListener('change', function() {
        const prefix = this.dataset.prefix;
        const row = document.querySelector(`tr.day-row[data-prefix="${prefix}"]`);
        const paid = row.querySelector(`input[name="${prefix}_break_paid"]`);
        if (this.checked && paid) paid.checked = false;
      });
    });
    document.querySelectorAll('.day-break-paid').forEach(chk => {
      chk.addEventListener('change', function() {
        const prefix = this.dataset.prefix;
        const row = document.querySelector(`tr.day-row[data-prefix="${prefix}"]`);
        const unpaid = row.querySelector(`input[name="${prefix}_break_unpaid"]`);
        if (this.checked && unpaid) unpaid.checked = false;
      });
    });

    // Botón copiar lunes al resto
    const copyBtn = document.getElementById('copy-first-day-btn');
    if (copyBtn) {
      copyBtn.addEventListener('click', copyFirstDayToOthers);
      // Deshabilitar si no está en modo por días
      if (!chk.checked) {
        copyBtn.disabled = true;
      }
    }
  });
</script>
{% endblock %}
