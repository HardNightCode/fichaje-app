{% extends "base.html" %}

{% block title %}Administración - Ubicaciones{% endblock %}

{% block content %}
<h1 class="mb-4">Administración de ubicaciones</h1>

<div class="row">
  <!-- FORMULARIO CREAR UBICACIÓN -->
  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-header">
        Crear nueva ubicación
      </div>
      <div class="card-body">
        <form action="{{ url_for('admin_ubicaciones') }}" method="post">
          <div class="mb-3">
            <label class="form-label">Nombre de la ubicación</label>
            <input type="text" name="name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Latitud</label>
            <input type="text" name="latitude" id="latitude" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Longitud</label>
            <input type="text" name="longitude" id="longitude" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Radio (metros)</label>
            <input type="text" name="radius_meters" class="form-control" value="100" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Seleccionar en el mapa</label>
            <div id="map-crear" style="height: 350px; border: 1px solid #ddd; border-radius: .25rem;"></div>
            <div class="form-text">
              Haz clic en el mapa para rellenar latitud y longitud automáticamente.
            </div>
          </div>

          <button type="submit" class="btn btn-success w-100">
            Crear ubicación
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- LISTADO DE UBICACIONES (sin Flexible) -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        Ubicaciones existentes
      </div>
      <div class="card-body p-0">
        {% if ubicaciones %}
          <div class="table-responsive">
            <table class="table table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th>Nombre</th>
                  <th>Latitud</th>
                  <th>Longitud</th>
                  <th>Radio (m)</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
              {% for loc in ubicaciones %}
                <tr>
                  <td>{{ loc.name }}</td>
                  <td>{{ "%.6f"|format(loc.latitude) }}</td>
                  <td>{{ "%.6f"|format(loc.longitude) }}</td>
                  <td>{{ loc.radius_meters }}</td>
                  <td>
                    <a href="{{ url_for('editar_ubicacion', loc_id=loc.id) }}"
                       class="btn btn-sm btn-primary">
                      Editar
                    </a>
                    <form action="{{ url_for('eliminar_ubicacion', loc_id=loc.id) }}"
                          method="post" class="d-inline"
                          onsubmit="return confirm('¿Seguro que quieres eliminar esta ubicación?');">
                      <button type="submit" class="btn btn-sm btn-danger">
                        Eliminar
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted p-3 mb-0">No hay ubicaciones definidas todavía.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<!-- Leaflet CSS y JS (CDN) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');

    // Centro por defecto (si geolocalización falla): Madrid
    const fallBackLat = 40.4168;
    const fallBackLon = -3.7038;
    const fallBackZoom = 6;

    let startLat = parseFloat(latInput.value);
    let startLon = parseFloat(lonInput.value);

    if (isNaN(startLat) || isNaN(startLon)) {
      startLat = fallBackLat;
      startLon = fallBackLon;
    }

    const map = L.map('map-crear').setView([startLat, startLon], fallBackZoom);

    // Capa base con POIs (tiendas, parques, etc.)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;      // marcador de la ubicación que estamos creando
    let userMarker = null;  // marcador de tu ubicación actual

    // Si ya había coordenadas en el formulario, ponemos marcador inicial
    if (!isNaN(startLat) && !isNaN(startLon) &&
        !(startLat === fallBackLat && startLon === fallBackLon && !latInput.value && !lonInput.value)) {
      marker = L.marker([startLat, startLon]).addTo(map);
    }

    // Geolocalización del navegador: centramos y marcamos tu ubicación
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const userLat = pos.coords.latitude;
          const userLon = pos.coords.longitude;

          // Centramos el mapa en tu ubicación
          map.setView([userLat, userLon], 15);

          // Marcador distintivo para tu ubicación actual
          userMarker = L.circleMarker([userLat, userLon], {
            radius: 8,
            color: '#0056b3',
            fillColor: '#0d6efd',
            fillOpacity: 0.8
          })
          .addTo(map)
          .bindPopup('Tu ubicación actual')
          .openPopup();
        },
        (err) => {
          console.warn('No se pudo obtener la ubicación actual:', err);
          // En este caso nos quedamos con el centro por defecto (Madrid o lo que haya en el form)
        }
      );
    }

    // Al hacer clic en el mapa, creamos o movemos el marcador de la ubicación y actualizamos inputs
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;

      if (marker) {
        marker.setLatLng(e.latlng);
      } else {
        marker = L.marker(e.latlng).addTo(map);
      }

      latInput.value = lat.toFixed(6);
      lonInput.value = lng.toFixed(6);
    });
  });
</script>
{% endblock %}
