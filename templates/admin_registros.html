{% extends "base.html" %}

{% block title %}Registros - Administración{% endblock %}

{% block content %}
<h1 class="mb-4">Panel de administración - Registros</h1>

<div class="card mb-4">
  <div class="card-header">Filtros</div>
  <div class="card-body">
    <form action="{{ url_for('admin_registros') }}" method="post" class="row g-3">

      <!-- Usuario -->
      <div class="col-md-3">
        <label class="form-label">Usuario</label>
        <select name="usuario_id" class="form-select">
          <option value="all" {% if usuario_seleccionado == 'all' %}selected{% endif %}>
            Todos
          </option>
          {% for u in usuarios %}
            <option value="{{ u.id }}"
                    {% if usuario_seleccionado|int == u.id %}selected{% endif %}>
              {{ u.username }} ({{ u.role }})
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Tipo de periodo -->
      <div class="col-md-3">
        <label class="form-label">Tipo de periodo</label>
        <select name="tipo_periodo" id="tipo_periodo" class="form-select">
          <option value="rango" {% if tipo_periodo == 'rango' %}selected{% endif %}>
            Rango de fechas
          </option>
          <option value="semanal" {% if tipo_periodo == 'semanal' %}selected{% endif %}>
            Semana
          </option>
          <option value="mensual" {% if tipo_periodo == 'mensual' %}selected{% endif %}>
            Mes
          </option>
          <option value="historico" {% if tipo_periodo == 'historico' %}selected{% endif %}>
            Histórico (todos)
          </option>
        </select>
      </div>

      <!-- Selector de fecha para la semana -->
      <div class="col-md-3" id="grupo-semana" style="display: none;">
        <label class="form-label">Semana</label>
        <input type="date" name="fecha_semana" class="form-control" value="{{ fecha_semana }}">
      </div>

      <!-- Mes -->
      <div class="col-md-2" id="grupo-mes" style="display: none;">
        <label class="form-label">Mes</label>
        <select name="mes" class="form-select">
          <option value="" {% if mes is none %}selected{% endif %}>Selecciona mes...</option>
          <option value="1"  {% if mes == 1 %}selected{% endif %}>Enero</option>
          <option value="2"  {% if mes == 2 %}selected{% endif %}>Febrero</option>
          <option value="3"  {% if mes == 3 %}selected{% endif %}>Marzo</option>
          <option value="4"  {% if mes == 4 %}selected{% endif %}>Abril</option>
          <option value="5"  {% if mes == 5 %}selected{% endif %}>Mayo</option>
          <option value="6"  {% if mes == 6 %}selected{% endif %}>Junio</option>
          <option value="7"  {% if mes == 7 %}selected{% endif %}>Julio</option>
          <option value="8"  {% if mes == 8 %}selected{% endif %}>Agosto</option>
          <option value="9"  {% if mes == 9 %}selected{% endif %}>Septiembre</option>
          <option value="10" {% if mes == 10 %}selected{% endif %}>Octubre</option>
          <option value="11" {% if mes == 11 %}selected{% endif %}>Noviembre</option>
          <option value="12" {% if mes == 12 %}selected{% endif %}>Diciembre</option>
        </select>
      </div>

      <!-- Fechas solo para "rango" -->
      <div class="col-md-2" id="grupo-fecha-desde">
        <label class="form-label">Fecha desde</label>
        <input type="date" name="fecha_desde" value="{{ fecha_desde }}" class="form-control">
      </div>

      <div class="col-md-2" id="grupo-fecha-hasta">
        <label class="form-label">Fecha hasta</label>
        <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}" class="form-control">
      </div>

      <!-- Filtro por ubicación -->
      <div class="col-md-3">
        <label class="form-label">Ubicación</label>
        <select name="ubicacion_filtro" class="form-select">
          <option value="all" {% if ubicacion_filtro == 'all' %}selected{% endif %}>Todas</option>
          <option value="flexible" {% if ubicacion_filtro == 'flexible' %}selected{% endif %}>
            Fuera de ubicaciones (Flexible)
          </option>
          {% for loc in ubicaciones_definidas %}
            <option value="{{ loc.id }}"
                    {% if ubicacion_filtro|int == loc.id %}selected{% endif %}>
              {{ loc.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Botones -->
      <div class="col-md-3 d-flex align-items-end">
        <div class="btn-group w-100">
          <button type="submit" name="accion" value="filtrar" class="btn btn-primary">
            Aplicar
          </button>
          <button type="submit" name="accion" value="csv" class="btn btn-outline-secondary">
            CSV
          </button>
          <button type="submit" name="accion" value="pdf" class="btn btn-success">
            PDF
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- RESUMEN HORAS POR USUARIO -->
<div class="card mb-4">
  <div class="card-header">Resumen de horas por usuario (en el periodo seleccionado)</div>
  <div class="card-body">
    {% if horas_por_usuario %}
      <ul class="list-group list-group-flush">
        {% for username, horas in horas_por_usuario.items() %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ username }}</span>
            <span class="fw-semibold">{{ horas }}</span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted mb-0">
        No hay suficientes registros para calcular horas con los filtros actuales.
      </p>
    {% endif %}
  </div>
</div>
<!-- FIN RESUMEN HORAS -->

<div class="card">
  <div class="card-header">Resultados</div>
  <div class="card-body p-0">
    {% if intervalos %}
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Entrada</th>
              <th>Salida</th>
              <th>Ubicación</th>
              <th class="text-end">Edición / Acciones</th>
            </tr>
          </thead>
          <tbody>
          {% for it in intervalos %}
            <tr class="intervalo-row" data-interval-id="{{ it.row_id }}">
              <td>{{ it.usuario.username }}</td>
              <td>{{ it.usuario.role }}</td>

              <td>
                {% if it.entrada_momento %}
                  {{ it.entrada_momento.strftime("%H:%M %d/%m/%Y") }}
                {% else %}
                  <span class="text-muted">Sin entrada</span>
                {% endif %}
              </td>

              <td>
                {% if it.salida_momento %}
                  {{ it.salida_momento.strftime("%H:%M %d/%m/%Y") }}
                {% else %}
                  <span class="text-muted">Sin salida</span>
                {% endif %}
              </td>

              <td>
                {% if it.label_entrada or it.label_salida %}
                  {% if it.label_entrada and it.label_salida and it.label_entrada == it.label_salida %}
                    {# Misma ubicación en entrada y salida -> solo una vez #}
                    {% if it.entrada_lat is not none and it.entrada_lon is not none %}
                      <a href="https://www.google.com/maps?q={{ it.entrada_lat }},{{ it.entrada_lon }}"
                         class="link-primary" target="_blank">
                        {{ it.label_entrada }}
                      </a>
                    {% else %}
                      {{ it.label_entrada }}
                    {% endif %}
                  {% else %}
                    {# Ubicaciones distintas o falta alguna #}
                    {% if it.label_entrada %}
                      {% if it.entrada_lat is not none and it.entrada_lon is not none %}
                        <a href="https://www.google.com/maps?q={{ it.entrada_lat }},{{ it.entrada_lon }}"
                           class="link-primary" target="_blank">
                          {{ it.label_entrada }}
                        </a>
                      {% else %}
                        {{ it.label_entrada }}
                      {% endif %}
                    {% endif %}
                    {% if it.label_entrada and it.label_salida %} - {% endif %}
                    {% if it.label_salida %}
                      {% if it.salida_lat is not none and it.salida_lon is not none %}
                        <a href="https://www.google.com/maps?q={{ it.salida_lat }},{{ it.salida_lon }}"
                           class="link-primary" target="_blank">
                          {{ it.label_salida }}
                        </a>
                      {% else %}
                        {{ it.label_salida }}
                      {% endif %}
                    {% endif %}
                  {% endif %}
                {% else %}
                  <span class="text-muted">Sin datos</span>
                {% endif %}
              </td>

              <td class="text-end align-top">
                {% set tiene_ediciones_entrada = it.entrada and it.entrada.ediciones and it.entrada.ediciones.count() %}
                {% set tiene_ediciones_salida = it.salida and it.salida.ediciones and it.salida.ediciones.count() %}

                {% if tiene_ediciones_entrada or tiene_ediciones_salida %}
                  <span class="small text-warning fw-semibold edit-toggle"
                        data-interval-id="{{ it.row_id }}"
                        title="Ver historial de ediciones">
                    Editado <span class="edit-toggle-sign" data-interval-id="{{ it.row_id }}">+</span>
                  </span>
                {% else %}
                  <span class="small text-muted d-block">Sin editar</span>
                {% endif %}

                <div class="mt-2">
                  <a href="{{ url_for('editar_registro', registro_id=it.row_id) }}"
                     class="btn btn-sm btn-primary">
                    Editar
                  </a>
                </div>
              </td>
            </tr>

            <!-- Fila expandible con historial de ediciones del intervalo -->
            <tr id="edit-details-{{ it.row_id }}" class="edit-details-row" style="display: none;">
              <td colspan="6" class="bg-light small">
                {% if tiene_ediciones_entrada %}
                  <strong>Historial de ediciones de la ENTRADA:</strong>
                  <ul class="mb-2 mt-1">
                    {% for e in it.entrada.ediciones %}
                      <li>
                        <strong>{{ e.edit_time }}</strong> –
                        editado por {{ e.editor.username if e.editor else 'usuario desconocido' }}
                        desde {{ e.editor_ip or 'IP desconocida' }}.<br>
                        Valores anteriores:
                        acción <code>{{ e.old_accion }}</code>,
                        fecha/hora <code>{{ e.old_momento }}</code>,
                        lat <code>{{ e.old_latitude }}</code>,
                        lon <code>{{ e.old_longitude }}</code>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}

                {% if tiene_ediciones_salida %}
                  <strong>Historial de ediciones de la SALIDA:</strong>
                  <ul class="mb-0 mt-1">
                    {% for e in it.salida.ediciones %}
                      <li>
                        <strong>{{ e.edit_time }}</strong> –
                        editado por {{ e.editor.username if e.editor else 'usuario desconocido' }}
                        desde {{ e.editor_ip or 'IP desconocida' }}.<br>
                        Valores anteriores:
                        acción <code>{{ e.old_accion }}</code>,
                        fecha/hora <code>{{ e.old_momento }}</code>,
                        lat <code>{{ e.old_latitude }}</code>,
                        lon <code>{{ e.old_longitude }}</code>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}

                {% if not tiene_ediciones_entrada and not tiene_ediciones_salida %}
                  <span class="text-muted">Este intervalo no tiene ediciones.</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted p-3 mb-0">No hay registros para los filtros seleccionados.</p>
    {% endif %}
  </div>
</div>

<script>
  function actualizarVisibilidadFechas() {
    var tipo = document.getElementById('tipo_periodo').value;
    var grupoSemana = document.getElementById('grupo-semana');
    var grupoMes = document.getElementById('grupo-mes');
    var grupoDesde = document.getElementById('grupo-fecha-desde');
    var grupoHasta = document.getElementById('grupo-fecha-hasta');

    if (tipo === 'rango') {
      grupoSemana.style.display = 'none';
      grupoMes.style.display = 'none';
      grupoDesde.style.display = '';
      grupoHasta.style.display = '';
    } else if (tipo === 'semanal') {
      grupoSemana.style.display = '';
      grupoMes.style.display = 'none';
      grupoDesde.style.display = 'none';
      grupoHasta.style.display = 'none';
    } else if (tipo === 'mensual') {
      grupoSemana.style.display = 'none';
      grupoMes.style.display = '';
      grupoDesde.style.display = 'none';
      grupoHasta.style.display = 'none';
    } else {
      grupoSemana.style.display = 'none';
      grupoMes.style.display = 'none';
      grupoDesde.style.display = 'none';
      grupoHasta.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    actualizarVisibilidadFechas();
    document.getElementById('tipo_periodo').addEventListener('change', actualizarVisibilidadFechas);

    // Toggle de historial de ediciones por intervalo
    document.querySelectorAll('.edit-toggle').forEach(function(el) {
      el.addEventListener('click', function() {
        const intervalId = this.getAttribute('data-interval-id');
        const detailsRow = document.getElementById('edit-details-' + intervalId);
        const signSpan = document.querySelector(
          '.edit-toggle-sign[data-interval-id="' + intervalId + '"]'
        );

        if (!detailsRow || !signSpan) return;

        if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
          detailsRow.style.display = 'table-row';
          signSpan.textContent = '-';
        } else {
          detailsRow.style.display = 'none';
          signSpan.textContent = '+';
        }
      });
    });
  });
</script>

{% endblock %}
