{% extends "base.html" %}
{% block title %}Panel de administración{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h3 mb-1">Panel de administración</h1>
      <p class="text-muted mb-0">Resumen diario y accesos rápidos.</p>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-md-6 col-xl-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Usuarios totales</div>
          <div class="display-6 fw-bold">{{ total_usuarios }}</div>
          <div class="small text-muted mt-2">
            Empleados {{ total_empleados }} · Admins {{ total_admins }} · Kioskos {{ total_kioskos }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Registros hoy</div>
          <div class="display-6 fw-bold">{{ registros_hoy }}</div>
          <div class="small text-muted mt-2">
            Entradas {{ entradas_hoy }} · Salidas {{ salidas_hoy }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Justificaciones hoy</div>
          <div class="display-6 fw-bold">{{ justificaciones_hoy }}</div>
          <div class="small text-muted mt-2">Horas extra justificadas.</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Horas extra</div>
          <div class="display-6 fw-bold">{{ extra_hoy }}</div>
          <div class="small text-muted mt-2">
            Semana {{ extra_semana }} · Defecto hoy {{ defecto_hoy }} · Semana {{ defecto_semana }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Acciones rápidas</div>
          <div class="d-grid gap-2 mt-3">
            <a class="btn btn-outline-primary" href="{{ url_for('admin_registros') }}">Ver registros</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('admin_usuarios_fichas') }}">Gestionar usuarios</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('admin_horarios') }}">Horarios</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('admin_kioskos') }}">Kioskos</a>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-header text-uppercase small">Resumen de horas</div>
        <div class="card-body text-center">
          {% if admin_user %}
            <p class="mb-1">
              Total de horas registradas en la semana seleccionada:
            </p>
            {% if admin_resumen_semana %}
              <p class="display-6 mb-0"><strong>{{ admin_resumen_semana }}</strong></p>
            {% else %}
              <p class="text-muted mb-0">Todavía no hay horas registradas.</p>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">No hay usuarios disponibles.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <span class="text-uppercase small d-block">Tus fichajes recientes</span>
            <span class="panel-subtitle small">Intervalos registrados y ubicación asociada</span>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <select class="form-select form-select-sm w-auto" id="adminUserSelect">
              {% for u in usuarios_admin %}
                <option value="{{ u.id }}" {% if admin_user and u.id == admin_user.id %}selected{% endif %}>
                  {{ u.username }}
                </option>
              {% endfor %}
            </select>
            <select class="form-select form-select-sm week-select" id="adminWeekSelect">
              {% for wk in admin_semanas_meta %}
                <option value="{{ wk.page }}" {% if wk.page == admin_week_page %}selected{% endif %}>
                  {{ wk.label }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          {% if admin_intervalos_semana %}
            <div class="px-3 py-2 border-bottom d-flex flex-wrap justify-content-between align-items-center gap-2">
              <div class="small text-muted me-auto">
                {{ admin_semana_label or "Semana actual" }}
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0 align-middle text-center">
                <thead class="table-light">
                  <tr>
                    <th>Entrada</th>
                    <th>Descanso</th>
                    <th>Salida</th>
                    <th>Ubicación</th>
                  </tr>
                </thead>
                <tbody>
                {% for it in admin_intervalos_semana %}
                  <tr>
                    <td>
                      {% if it.entrada_momento %}
                        {{ (it.entrada_momento|to_local).strftime("%H:%M %d/%m/%Y") }}
                      {% else %}
                        <span class="text-muted">Sin entrada</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if it.descanso_en_curso %}
                        <span class="text-warning descanso-en-curso"
                              data-descanso-inicio="{{ it.descanso_inicio_iso }}"
                              data-descanso-base="{{ it.descanso_base_segundos | default(0) }}">
                          Descansando ·
                          <span class="descanso-tiempo">--:--:--</span>
                        </span>
                      {% else %}
                        {{ it.descanso_label or "Sin descanso" }}
                      {% endif %}
                    </td>
                    <td>
                      {% if it.salida_momento %}
                        {{ (it.salida_momento|to_local).strftime("%H:%M %d/%m/%Y") }}
                      {% else %}
                        <span class="text-muted">Sin salida</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if it.label_entrada or it.label_salida %}
                        {% if it.label_entrada and it.label_salida and it.label_entrada == it.label_salida %}
                          {% if it.entrada_lat is not none and it.entrada_lon is not none %}
                            <a href="https://www.google.com/maps?q={{ it.entrada_lat }},{{ it.entrada_lon }}"
                               class="link-primary" target="_blank">
                              {{ it.label_entrada }}
                            </a>
                          {% else %}
                            {{ it.label_entrada }}
                          {% endif %}
                        {% else %}
                          {% if it.label_entrada %}
                            {% if it.entrada_lat is not none and it.entrada_lon is not none %}
                              <a href="https://www.google.com/maps?q={{ it.entrada_lat }},{{ it.entrada_lon }}"
                                 class="link-primary" target="_blank">
                                {{ it.label_entrada }}
                              </a>
                            {% else %}
                              {{ it.label_entrada }}
                            {% endif %}
                          {% endif %}
                          {% if it.label_entrada and it.label_salida %} - {% endif %}
                          {% if it.label_salida %}
                            {% if it.salida_lat is not none and it.salida_lon is not none %}
                              <a href="https://www.google.com/maps?q={{ it.salida_lat }},{{ it.salida_lon }}"
                                 class="link-primary" target="_blank">
                                {{ it.label_salida }}
                              </a>
                            {% else %}
                              {{ it.label_salida }}
                            {% endif %}
                          {% endif %}
                        {% endif %}
                      {% else %}
                        <span class="text-muted">Sin datos</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="px-3 py-2 border-top d-flex justify-content-between align-items-center">
              <button class="btn btn-sm btn-outline-secondary" id="adminPrevWeek" {% if admin_week_page <= 1 %}disabled{% endif %}>Anterior</button>
              <span class="small text-muted">Página {{ admin_week_page }} de {{ admin_total_pages }}</span>
              <button class="btn btn-sm btn-outline-secondary" id="adminNextWeek" {% if admin_week_page >= admin_total_pages %}disabled{% endif %}>Siguiente</button>
            </div>
          {% else %}
            <p class="text-muted p-3 mb-0 text-center">
              No hay fichajes registrados para este usuario.
            </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const userSelect = document.getElementById('adminUserSelect');
    const weekSelect = document.getElementById('adminWeekSelect');
    const prevBtn = document.getElementById('adminPrevWeek');
    const nextBtn = document.getElementById('adminNextWeek');

    function goTo(userId, weekPage) {
      const params = new URLSearchParams();
      if (userId) params.set('user_id', userId);
      if (weekPage) params.set('week_page', weekPage);
      window.location.href = `/?${params.toString()}`;
    }

    if (userSelect) {
      userSelect.addEventListener('change', () => {
        goTo(userSelect.value, 1);
      });
    }
    if (weekSelect) {
      weekSelect.addEventListener('change', () => {
        goTo(userSelect ? userSelect.value : '', weekSelect.value);
      });
    }
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        const current = parseInt(weekSelect.value || '1', 10);
        goTo(userSelect ? userSelect.value : '', Math.max(1, current - 1));
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        const current = parseInt(weekSelect.value || '1', 10);
        goTo(userSelect ? userSelect.value : '', current + 1);
      });
    }
  })();
</script>
{% endblock %}
