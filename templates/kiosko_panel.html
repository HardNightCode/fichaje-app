{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-3">
    <h2 class="mb-1">Kiosko: {{ kiosk.name }}</h2>
    <p class="text-muted mb-3">
        Modo kiosko activo. Selecciona tu usuario, indica el PIN y la acción de fichaje.
    </p>

    {# Mensajes flash #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if kiosk_users %}
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
            {% for ku in kiosk_users %}
                {% set u = ku.user %}
                <div class="col">
                    <div class="card h-100 shadow-sm {% if last_user_id == u.id %}border border-primary{% endif %}"
                         data-user-id="{{ u.id }}"
                         data-last-selected="{% if last_user_id == u.id %}1{% else %}0{% endif %}">
                        <div class="card-body d-flex flex-column">
                            <h4 class="card-title text-center mb-3">{{ u.username }}</h4>

                            <form method="post" action="{{ url_for('fichar') }}" class="d-flex flex-column flex-grow-1">
                                <input type="hidden" name="usuario_id" value="{{ u.id }}">
                                <input type="hidden" name="lat" value="">
                                <input type="hidden" name="lon" value="">
                                <input type="hidden" name="motivo_extra" value="">
                                <input type="hidden" name="detalle_extra" value="">

                                <div class="mb-2">
                                    <label for="pin_{{ u.id }}" class="form-label">
                                        PIN (4 dígitos)
                                    </label>
                                    <input type="password"
                                           class="form-control form-control-lg text-center"
                                           id="pin_{{ u.id }}"
                                           name="pin"
                                           pattern="\d{4}"
                                           inputmode="numeric"
                                           maxlength="4"
                                           required>
                                </div>

                                <div class="mt-2 mb-2 text-center">
                                    <small class="text-muted">
                                        Selecciona la acción que quieres fichar:
                                    </small>
                                </div>

                                <div class="btn-group mb-2" role="group">
                                    <button type="submit"
                                            name="accion"
                                            value="entrada"
                                            class="btn btn-success btn-sm">
                                        Entrada
                                    </button>
                                    <button type="submit"
                                            name="accion"
                                            value="salida"
                                            class="btn btn-danger btn-sm">
                                        Salida
                                    </button>
                                </div>

                                <div class="btn-group mb-2" role="group">
                                    <button type="submit"
                                            name="accion"
                                            value="descanso_inicio"
                                            class="btn btn-warning btn-sm">
                                        Inicio descanso
                                    </button>
                                    <button type="submit"
                                            name="accion"
                                            value="descanso_fin"
                                            class="btn btn-warning btn-sm">
                                        Fin descanso
                                    </button>
                                </div>

                                <div class="mt-auto text-center">
                                    <small class="text-muted d-block">
                                        La ubicación se obtiene automáticamente del dispositivo.
                                    </small>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No hay usuarios asignados a este kiosko.</p>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    if (!navigator.geolocation) {
        console.warn("Geolocalización no soportada en este navegador.");
    } else {
        function setGeoCoords(lat, lon) {
            const latInputs = document.querySelectorAll('input[name="lat"]');
            const lonInputs = document.querySelectorAll('input[name="lon"]');
            latInputs.forEach(function (inp) { inp.value = lat; });
            lonInputs.forEach(function (inp) { inp.value = lon; });
        }

        navigator.geolocation.getCurrentPosition(
            function (pos) {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                setGeoCoords(lat, lon);
            },
            function (err) {
                console.warn("No se pudo obtener la geolocalización:", err);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000
            }
        );
    }

    // Auto-focus del PIN del último usuario si “no se cierra la sesión visual”
    const selectedCard = document.querySelector('.card[data-last-selected="1"]');
    if (selectedCard) {
        const pinInput = selectedCard.querySelector('input[name="pin"]');
        if (pinInput) {
            pinInput.focus();
        }
    }

    // Modal de justificación para salidas
    const modalTemplate = `
    <div class="modal fade" id="modalExtraK" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Justificar horas extra</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p class="small text-muted">Indica el motivo si la jornada supera lo previsto.</p>
            <div class="mb-3">
              <label class="form-label">Motivo</label>
              <select class="form-select" id="selectMotivoK">
                <option value="">Selecciona...</option>
                <option value="Incidencia operativa">Incidencia operativa</option>
                <option value="Atención a cliente urgente">Atención a cliente urgente</option>
                <option value="Tarea crítica no planificada">Tarea crítica no planificada</option>
                <option value="Cobertura de turno">Cobertura de turno</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Detalle</label>
              <textarea class="form-control" id="inputDetalleK" rows="2" placeholder="Describe brevemente si elegiste 'Otro'"></textarea>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="confirmExtraK">
              <label class="form-check-label" for="confirmExtraK">Confirmo que la información es correcta.</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnEnviarExtraK">Enviar</button>
          </div>
        </div>
      </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', modalTemplate);
    const modalK = new bootstrap.Modal(document.getElementById('modalExtraK'));
    const selectMotivoK = document.getElementById('selectMotivoK');
    const inputDetalleK = document.getElementById('inputDetalleK');
    const confirmExtraK = document.getElementById('confirmExtraK');
    const btnEnviarExtraK = document.getElementById('btnEnviarExtraK');
    let formPendiente = null;

    document.querySelectorAll('form[action="{{ url_for("fichar") }}"]').forEach(form => {
      form.addEventListener('submit', function (ev) {
        const submitter = ev.submitter;
        if (submitter && submitter.value === 'salida') {
          ev.preventDefault();
          formPendiente = form;
          modalK.show();
        }
      });
    });

    btnEnviarExtraK.addEventListener('click', () => {
      if (!confirmExtraK.checked) {
        alert('Confirma que la información es correcta.');
        return;
      }
      if (formPendiente) {
        formPendiente.querySelector('input[name="motivo_extra"]').value = selectMotivoK.value;
        formPendiente.querySelector('input[name="detalle_extra"]').value = inputDetalleK.value;
        modalK.hide();
        formPendiente.submit();
        formPendiente = null;
      }
    });
});
</script>

{% endblock %}
